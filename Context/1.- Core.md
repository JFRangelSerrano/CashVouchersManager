# Project Prompt: EvoCashVouchersManager API

## 1. Resumen del Proyecto

Crear una API WEB RESTful sólida para la gestión de vales canjeables por dinero, usando controladores ASP.NET Core.

- **Lenguaje:** C#
- **Framework:** .NET 8

El objetivo inicial es establecer:
- Una arquitectura DDD limpia
- Una capa de persistencia funcional
- La creación básica de vales

---

## 2. Arquitectura

La solución debe seguir **Diseño Guiado por el Dominio (DDD)** y estar compuesta por los siguientes proyectos:

- **CashVouchersManager.Domain**
- **CashVouchersManager.Application**
- **CashVouchersManager.Infrastructure**
- **CashVouchersManager.API**
- **CashVouchersManager.DTO**

Las responsabilidades deben estar estrictamente separadas.

### Proyecto DTO

El proyecto **CashVouchersManager.DTO** es el encargado de definir:
- Todos los DTOs:
  - `GenerateCashVoucherRequestDTO`
  - `CashVoucherDTO`
  - `RedeemCashVoucherRequestDTO`
- Todas las enumeraciones necesarias que deban ser compartidas y usadas en el resto de proyectos.

---

## 3. Modelo de Dominio

### Entidad: `CashVoucher`

#### Propiedades

- `Code` (string): Código del vale en formato **EAN13**. **No es clave primaria**.
- `Amount` (decimal): Importe del vale en euros (2 decimales).
- `CreationDate` (DateTime): Fecha de creación en UTC.
- `IssuingStoreId` (int): Código del establecimiento emisor (máx. 4 dígitos).
- `RedemptionDate` (DateTime?): Fecha de canje. Nulable.
- `ExpirationDate` (DateTime?): Fecha de expiración. Nulable.
- `IssuingSaleId` (string?): Opcional, máximo 128 caracteres.
- `RedemptionSaleId` (string?): Opcional, máximo 128 caracteres.

#### Nota importante sobre la clave

La entidad `CashVoucher` **no posee ninguna propiedad que actúe como clave primaria**.

- La propiedad `Code` se utiliza como identificador principal para consultas.
- Puede haber múltiples instancias de `CashVoucher` con el mismo `Code`.
- Por este motivo:
  - Todas las consultas por `Code`
  - Todas las operaciones basadas en `Code`

**deben devolver listas de `CashVoucher`**, nunca una única instancia.

---

### Estado del Vale (`Status`)

Además de las propiedades persistidas, un `CashVoucher` posee una **propiedad calculada en memoria** llamada `Status`, cuyo valor se determina según la siguiente lógica:

- **Redeemed**: si `RedemptionDate` no es nula
- **Expired**: si `ExpirationDate` es anterior a la fecha actual
- **Active**: en cualquier otro caso

Esto requiere la creación de la enumeración:

#### `CashVoucherStatusEnum`
- Active
- Redeemed
- Expired

---

### Notas técnicas para pruebas / Unit Tests (Entity Framework Core)

- Al no existir clave primaria, **EF Core no puede trackear** instancias de `CashVoucher`.
- Las pruebas que requieran persistencia deben:
  - Evitar el tracking (no usar `Add` / `AddRange` sobre `DbSet`)
  - Sembrar datos mediante **SQL crudo**
- Se recomienda usar **SQLite In-Memory** para simular correctamente la persistencia sin clave primaria.

---

## 4. Generación del Código del Vale

El valor de `Code` debe cumplir el estándar **EAN13** y generarse de la siguiente forma:

1. Código del establecimiento (4 dígitos, rellenados con ceros a la izquierda).
2. Secuencia numérica aleatoria hasta completar 12 dígitos.
3. Cálculo del dígito de control EAN13 como 13º dígito.

Restricciones a cumplir por el `Code` a generar:

- El `Code` no debe existir en ningún vale **activo**
- Un vale es **inactivo** si:
  - Está canjeado
  - O está caducado desde hace más de 30 días
- Si existe colisión, se debe regenerar el `Code` hasta que no la haya

---

## 5. Persistencia

- **Base de datos:** SQLite
- **Fichero:** Creación automática en el directorio de ejecución
- **ORM:** Entity Framework Core
- **Migraciones:** Aplicadas automáticamente al arrancar la aplicación
- **Índices:**
  - Índice **no único** sobre el campo `Code`

---

## 6. Capa API

### Endpoints

---

### POST `/api/GenerateCashVoucher`

- Crea un nuevo vale
- Devuelve un `CashVoucherDTO`

---

### GET `/api/GetCashVoucherByCode/{code}`

Devuelve una lista con todos los vales que coincidan con el `Code`.

Parámetros:
- `onlyActives` (bool, por defecto `true`)
  - Si es `true`, debe devolver únicamente aquellos cuyo estado sea **Active**

---

### GET `/api/GetFilteredCashVouchers`

Devuelve un listado de vales filtrado dinámicamente.

#### Parámetros (todos opcionales)

- `status` (`CashVoucherStatusEnum`)
- `issuingStoreId` (int)
- `dateFrom` (DateTime)
- `dateTo` (DateTime)
- `dateType` (`CashVoucherDateTypeEnum`)

Para determinar el tipo de fecha por el que se desea filtrar, se debe crear la siguiente enumeración:

#### `CashVoucherDateTypeEnum`
- Creation
- Redemption
- Expiration

#### Reglas de filtrado por fechas

- Todos los parámetros pueden ser nulos.
- Solo se debe filtrar por aquellos parámetros que no lo sean.
- `dateType`:
  - Tiene como valor por defecto **Creation**
  - Solo se utiliza si `dateFrom` y/o `dateTo` han sido informados

---

### PUT `/api/RedeemCashVoucher/{code}`

#### Reglas de negocio

- El canje afecta a **todos los vales activos** con ese `Code`
- Si no se indica fecha y hora de canje, se debe usar `DateTime.UtcNow`

#### DTO: `RedeemCashVoucherRequestDTO`

- `RedemptionDate` (opcional)
- `RedemptionSaleId` (opcional)

---

## 7. Reglas Transversales

- La propiedad `Status`:
  - Es calculada en memoria
  - **No existe en el repositorio subyacente**
  - No puede usarse directamente en consultas a base de datos
  - Cualquier comprobación de estado debe aplicar la lógica basada en las demás propiedades
- Todas las fechas deben manejarse en **UTC**.
- Todas las fechas recibidas y enviadas a través de los endpoints deben entenderse como fechas UTC.
- Todo el código debe escribirse en **inglés**
