# Extensión de Funcionalidad: Control de Concurrencia y Estado InUse

Este documento debe interpretarse como una **extensión de la aplicación** definida en el archivo `1.- Core.md` del proyecto, y debe aplicarse después de haber procesado dicho archivo.

---

## 1. Control de Concurrencia

- Usar el flag `InUse` para prevenir condiciones de carrera.
- Todas las operaciones que modifiquen el estado de los vales deben ser **transaccionales**.

---

## 2. Cambios en el Modelo de Dominio

### Entidad: `CashVoucher`

#### Nueva propiedad persistida

- `InUse` (bool): Indica si el vale está siendo utilizado actualmente.
  - Valor por defecto: `false`

---

### Estado del Vale (`Status`) – Ampliación

La propiedad calculada `Status` de un `CashVoucher` incorpora ahora un nuevo valor adicional: **InUse**.

La lógica completa para determinar el estado es la siguiente:

- **Redeemed**: si `RedemptionDate` no es nula
- **Expired**: si `ExpirationDate` es anterior a la fecha actual
- **InUse**: si `InUse == true`
- **Active**: en cualquier otro caso

> Nota: `Status` sigue siendo una propiedad **calculada en memoria**, no persistida.

---

### Enumeración `CashVoucherStatusEnum`

La enumeración existente debe ampliarse para incluir el nuevo valor:

- Active
- Redeemed
- Expired
- InUse

---

## 3. Cambios en los DTOs

### `CashVoucherDTO`

Se debe añadir una nueva propiedad:

- `InUse` (bool): Indica si el `CashVoucher` asociado se encuentra actualmente en uso.

---

## 4. Cambios en la Capa API

### Endpoints

---

### POST `/api/SetCashVouchersInUse/{code}`

Permite establecer el valor del flag `InUse` para los vales asociados a un determinado `Code`.

#### Comportamiento

- Recibe un parámetro booleano para establecer `InUse` en `true` o `false`.

**Cuando `InUse = true`:**
- La operación se aplica **solo a los vales que NO estén redimidos ni expirados**.
- Se deben filtrar automáticamente los vales por estado antes de actualizar.
- Los vales redimidos o expirados se ignoran silenciosamente (no se genera error).

**Cuando `InUse = false`:**
- La operación se aplica a **todos los vales** que coincidan con el `Code`.
- **No se debe filtrar por estado** al seleccionar los vales.

---

### PUT `/api/RedeemCashVoucher/{code}`

Este endpoint ya existe y se amplía con nuevas reglas de negocio.

---

## 5. Nuevas Reglas de Negocio

- El canje afecta a **todos los vales activos** con ese `Code`, **independientemente del valor de `InUse`**.
- Tras completar la operación de canje:
  - El flag `InUse` debe establecerse obligatoriamente a `false`.

